# < 개발 일지 >
---------------------------------------------

## ※ 확인된 버그


-------------------------------------------------------------------

## 개선이 필요한 것

* 타일이 파괴된 이후 타일을 채우는 속도가 너무 빠르다. (마치 중력을 받는듯한 느낌으로 내려오게끔 하면 좋겠다.)
>> 앞으로 스킬 및 AI를 구현할 때, 개발 난이도를 쉽게 하기 위해서 스프라이트를 대입시키는 것이 아닌
   타일을 생성하고 파괴하는 방향으로 갈까 생각.
-------------------------------------------------------------------

## Last Update

## 2021.04.14 (수)

<오늘 목표>
확인된 버그들을 해결

1. (완료) 가끔씩 연속연결상태가 아닌데도 콤보가 사라지지 않는 문제\
-> 콤보가 계속 유지되는 조건
   그리고 콤보가 사라져야되는 조건을 명확하게 이해하자.

> 콤보가 오르는 경우 : 매칭타일을 찾았을 때 ++;
      콤보가 초기화되는 경우 : 사라진 sprite가 없을 때 = 0;
      조건을 명확하게 파악하고 코드를 짜니 잘 되는듯 하다.


2. (완료) 맨 위에서 타일을 매칭하면 새로운 타일이 리필되지 않는 문제\
-> 타일을 새로 생성하는 방식\
	타일을 매칭했을 때, 매칭된 타일의 y좌표가 동일한(같은 열에 있는) 타일을 위쪽 방향으로 전부 탐색하여 renderList에 추가한다.
	sprite가 비어있는 타일이 있을 경우 nullCount를 센다.
	renderList에 등록된 스프라이트 갯수 -1 만큼, 스프라이트를 아래쪽 타입으로 대입하는 루프를 거친다. \
-> 맨 윗줄 타일은 새로 위에서 받아올 스프라이트가 존재하지 않기 때문에, null로 남는 것.

> 윗줄을 하나 더 생성하면 되는 것이 아닌가? \
  그렇게 했더니 잘된다. \
  하지만 위에 타일 한 줄이 더 생겨서 보기가 안좋다. 가릴 수단이 필요하다. 


3. (완료) 가끔씩 새로운 타일이 빈자리를 매우지 못하는 문제.
-> 타일이 내려오는 코루틴에 문제가 있는 듯 하다.

스프라이트의 빈자리를 위에서 아래로 옮겨 채워가는 도중에 아래에 새로운 매칭이 생겨, 새로운 공백이 생겨버리면
그 공백을 새로 매우지 못한다.

> 차라리 BoardManager에서 , 실시간으로 빈 공간을 탐색해서 ShiftTileDown 코루틴을 실행시키는건 어떨까?\
  그렇게 했지만 안된다. 코루틴을 Unity가 임의로 실행시키다보니 동작과정이 뒤죽박죽이다.\
  그냥 일반함수로 되돌리자.\
  되돌리니까 되긴 하는데, 바로 뻗뻗하게 내려와서 보기 좀 그렇다. 개선할 필요가 있다.


---------------------------------------------

### 개발 플로우 차트

개 X발 FlowChart

1. ♥ 게임 시작시 게임 보드 실행
2. ♥ 게임 보드 안에 Tile들이 랜덤하게 배치
	* Tile들은 [i,j]값을 가지는 배열로 배치된다.
	* Tile들은 여러개의 고유한 ImagePrefab을 가진다.

3. ♥ Nodepiece들을 이동시키는 함수를 구현한다.
	* 마우스 입력을 받아 실행 - 이벤트 핸들러를 추가하여
	* Tile을 클릭 시, 이미지 가장자리에 테두리를 그려 클릭이 되었다는 것을 확인시킨다.
	* 클릭상태에서 다른 인접한 노드를 클릭할 경우, 서로의 위치를 바꾼다.

4. ♥ Tile들이 연결 조건을 만족시켰을 경우를 검사한다.
	* 1x3 을 만들었을 경우
	* 2x2 를 만들었을 경우
	* 그외 라인들이 겹치는 특수한 경우들은 어떻게 처리할 것인가?
	Raycast로 검사하는 것은 어떨까?

5. ♥ 연결조건을 만족시키면, 해당 Tile의 sprite를 없애고 빈 자리를 채운다.
	* 빈 자리를 채울 때 랜덤하게 어떤 방식으로 채울 것인가?

6. ♥ 연속으로 Tile의 sprite가 만족되어 파괴되는 횟수를 세어 콤보시스템을 만든다

7. ♥ 점수가 지속적으로 유지되며 더해지게 만든다.
	* 획득한 콤보에 따라 추가 점수를 얻을 수 있게끔 구현
	* 한번에 파괴되는 Tile의 sprite 갯수가 많을 수록 

8. ♥ 제한시간을 추가하고, 제한시간이 끝나면 게임이 종료하도록 만든다.

9. 스킬 게이지를 추가하고, 스킬 아이콘을 만들자.
	* 스킬 게이지는 Tile을 맞출 수록 게이지가 차오른다.
	* 스킬을 사용 시, 일정 게이지를 소모하고 특수 효과를 사용할 수 있다.

10. 각 스킬들의 특수 효과들을 구현한다.
	* 스킬의 동작 베이스는 윗부분을 참고
	* 작업량이 많고 여러 함수들을 구현해야할듯
	※ 가장 어려운 부분이 아닐까 생각 

11. AI와 대전하는 모드를 만든다
	* AI의 동작을 어떻게 구현할 것인가?
	* 정확도? 빈도?
	* AI도 일정 시간이 지나면 특수 스킬을 사용
	* 그러나 너무 터무니없는 기능이 아니도록

12. 여러 스테이지를 만든다.
	* 여러 상대와 싸울 수 있는 스테이지를 만든다.
	* 연속 전투 기능으로 구현할 계획

13. 게임 결과화면을 만든다.
	* 점수, 시간 등 몇가지 기준을 잡아 랭크 시스템을 만들어 보여준다.
	* 위의 각 최고 기록들이 보관되도록 만든다.(playerPref을 임시로 사용)

14. 일시정지 메뉴를 만든다.
	* 일시정지시에 시간이 멈추도록 한다.
	* 사용자의 동작을 제한시킨다.
	* 메뉴로 가기, 돌아가기 기능을 넣는다.

15. 타이틀 및 메뉴 씬과 로딩 씬을 구현한다.
	* 비동기식 실행으로 구현
	* 로딩 씬에는 랜덤하게 팁 문구 및 사진이 나오도록

16. 외부에서 이미지를 가져와 스프라이트를 덧씌운다.
	* Aseprite - 픽셀아트툴을 이용하여 여러 도트들을 찍을 계획.
	* Piskel 무료 아트툴을 추천받았음.

17. 외부에서 배경음, 효과음을 가져와 적용한다.

18. 프로토타입을 배포하고 피드백을 받는다.

--------------------------------------------------

### 이전 개발 일지

#### 2021.04.13 (화)

1. (완료) 콤보시스템을 만들기
	* 연속적인 연결이 계속 될 경우 콤보를 측정하는 카운트 변수를 만들고 출력하게 한다.
	* 연속적인 콤보중인지 확인하는 int matchFoundCount 변수 만들기
		-matchFoundCount 스왑한 이후 MatchFound한 경우가 있다면 ++;
		-만약 Count가 0이면 타일 연속 연결을 실패한 것. -> GUIManager의 ComboCount를 0으로
	* 콤보가 2이상 연결되면 화면에 출력하기(활성화하기)
	* 연속 연결 실패시 비활성화하기

2. (완료) 콤보가 높을수록 더해지는 점수도 많게 하기
	* 타일 매칭시 1개당 50점.
	* 점수 = (기본점수 * 매칭 갯수) * (ComboCount+1) (추후에 더 나은 방향으로 식을 설정)


3. (완료) 제한시간을 추가한다.
	* 제한시간을 float 변수로 만들어 프로퍼티로 사용
	* Mathf.Round를 사용하여 화면에서는 int로 보이게끔 해준다.
	* 제한시간이 0이 되면 게임 오버가 되도록 만들기

4. (완료) 점수를 업데이트할 때, 3자리마다 콤마를 넣도록 하기
    * ScoreWithComma() 함수를 만들어서 해결.


5. (완료) 사운드 매니저를 수정
	* 여러 효과음들과 배경음악들을 하나의 스크립트로 관리하도록 짜기
	* 오디오소스 효과음은 여러개, 배경음악은 하나만
	* 효과음과 배경음 클립들을 저장하는 배열 생성
	* for문으로 탐색을 돌려서, 매개변수와 저장된 클립이 일치하면 그것을 오디오소스에 집어넣어 소리 실행.
	* 효과음, 배경음 재생을 멈추는 함수를 생성

6. (완료) 배경 임시 삽입
	* 배경을 임시로 설정
	* Canvas들을 ScreenSpace - Camera로 바꾼 뒤, RenderCamera를 MainCamera로 설정.
	* 각 캔버스들의 Plane Distance를 조절해서 캔버스 위치를 조정

7. (완료) GameManager를 개선
	* 각각의 스크립트를 GameManager에서 관리할 수 있도록 수정.
	* 독립적인 다른 Manager(SoundManager 등)은 넣지 않았다.

8. (완료) 게임 오버가 된 이후에도 보드가 활성화되어 옮길 수 있는 현상을 수정



#### 2021.04.12 (월)

1. (완료) 타일 랜덤 생성
	* BoardManger를 생성하고, 에디터에서 정한 가로세로 사이즈만큼 시작점을 기준으로 타일들을 생성하는 함수를 구현
	* 생성된 타일 안에 저장한 캐릭터 스프라이트들을 랜덤으로 적용하도록 구현
	* 캐릭터 스프라이트들이 생성 시, 바로 3개가 연결되어 나오게 하지 않도록 구현

2. (완료) 타일 Swap
	* 타일 스프라이트를 선택할 수 있도록 OnMouseDown 함수를 사용
	* 타일을 선택할 때, 색상이 얕은 검은색상으로 바뀌고 선택 사운드가 나오도록 구현
	* 이전에 선택한 타일과 그 다음 선택한 타일이 서로 가까운지를 검색하는 함수를 구현\
	  RayCast를 이용해서 이전에 선택한 타일과 그 다음 선택한 타일의 4방향을 쏴서 일치하는지를 확인\
	* 위의 경우가 일치한다면, 서로의 스프라이트를 교체

3. (완료) 타일 매칭
	* 지역리스트를 생성하고 RayCast를 이용해서 옮겨진 타일의 주변에 같은 타일이 존재한다면 리스트에 저장
	* 저장한 리스트의 원소가 2개가 넘으면 매칭이 성립
	* 위의 부분을 상하, 좌우로 나누어 2번 탐색한다.

4. (완료) 타일 사라짐 , 위의 타일이 빈자리로 내려오기
	* 매칭이 성립한 스프라이트를 전부 null시킨다.
	* BoardManager에서, 비어있는 스프라이트가 있으면 그 부분을 채우는 코루틴을 실행

5. (완료) 새로운 타일이 위에서 계속 생성되도록 만들기
	* 새로운 스프라이트를 랜덤하게 받아와서, 각각 비어있는 타일 안의 빈 스프라이트에 적용

6. (완료) 점수 시스템 생성
	* Score변수를 프로퍼티로 생성
	* 빈 타일을 메우는 순간에 점수가 오르도록 설정. (추후 조정)
